Project description


sudo i2cdump -y 0 0x6f
sudo i2cset -y 0 0x29 0x54 0x01

sudo i2cget -y 0 0x6f 0x00





esptool.py --port COM10 flash_id

$ esptool.py --port COM10 flash_id
esptool.py v2.5.0
Serial port COM10
Connecting........__
Detecting chip type... ESP32
Chip is ESP32D0WDQ6 (revision 0)
Features: WiFi, BT, Dual Core
MAC: 24:0a:c4:81:76:7c
Uploading stub...
Running stub...
Stub running...
Manufacturer: c8
Device: 4016
Detected flash size: 4MB
Hard resetting via RTS pin...

esptool.py --chip esp32 --port COM10 erase_flash

esptool.py --port COM10 write_flash -fm qio 0x00000 boot_v1.2+.bin 0x01000 user1.1024.new.2.bin 0xfc000 esp_init_data_default.bin 0x7e000 blank.bin

esptool.py --chip esp32 --port ${FLASH_COMPORT} --baud ${FLASH_BDRATE} --before default_reset --after no_reset write_flash -z --flash_mode dio --flash_freq 40m --flash_size detect 0x1000 bootloader/bootloader.bin 0xf000 phy_init_data.bin 0x10000 MicroPython.bin 0x8000 partitions_mpy.bin 

esptool.py --chip esp32 --port COM10 --before default_reset --after no_reset write_flash -z --flash_mode dio --flash_freq 40m --flash_size detect 0x1000 bootloader.bin 0xf000 phy_init_data.bin 0x10000 MicroPython.bin 0x8000 partitions_mpy.bin 





cd ~/esp/MicroPython_ESP32_psRAM_LoBo/MicroPython_BUILD


To change some ESP32 & Micropython options or to create initial sdkconfig run:
    ./BUILD.sh menuconfig
CONFIG_ESP32_PANIC_PRINT_REBOOT=y


esptool.py --chip esp32 --port COM10 write_flash -z 0x1000 binp.bin


cd ~/esp/mpgsmcv/mpgsm/


ampy --port COM10 put wavecom.py
ampy --port COM10 put mpgsm.py


ampy --port COM10 get main.py

После прерывания, запустить можно
mpgsm.device.MainWavecom()


/*          For debug RS485                             */

mpgsm.device.en485pin.value(1)
mpgsm.device.GetDevData(1)
mpgsm.device.en485pin.value(0)

mpgsm.device.uDevice.read(1)

mpgsm.device.en485pin.value(1)
mpgsm.device.en485pin.value(0)
mpgsm.device.uDevice.any()


/*          For debug server data                       */
stroka =  {"cmd":"GETDATA","id":1,"msg":{"devID":1},"timestamp":"13:1:18"}
mpgsm.device._analis_server_socket_buff_(stroka)


http://185.41.186.74:1880/data

buff = '{"cmd":"SETDATA","ID":1,"msg":{"Iust":[0.15],"Uust":[0.25]},"timestamp":"11:41:10"}'
mpgsm.device._analis_server_socket_buff_(buff)

01062009000f120c
data=bytearray(b'\x01\x06 \t\x00\x0f\x12\x0c')

mpgsm.device.en485pin.value(1)
mpgsm.device.uDevice.write(data)
mpgsm.device.en485pin.value(0)




cmd_dict ={"cmd":"SETDATA","ID":1,"msg":{"Iust":[0.15],"Uust":[0.25]},"timestamp":"11:41:10"}




команда от сервера
{"cmd":"SETDATA","ID":1,"msg":{"Iust":[0.15],"Uust":[0.25]},"timestamp":"11:41:10"}

ModBUS для 485
self.uDevice = UART(2, baudrate=9600, rx=16, tx=17, timeout=3000)


Модем WAVECOM
Подключение через self.uGSM = UART(1, baudrate=115200, rx=22, tx=23, timeout=3000)

Запросс всех регистров
01h, 03h, 20h, 00h, 00h, 0Ch, 4Eh, 0Fh
Ответ
0       1       2       3   4    5 6        7 8     9 10        11 12       13 14       15 16
01h,    03h,    18h,    13h,88h, 09h,C4h,   13h,88h, 07h,D0h,   25h,1Ch,    00h,00h,    00h,00h, 05h,DCh, 07h,C6h, 00h,00h, 00h,00h, 00h,00h, DFh,92h

Вопроссы

Данные должны быть в реальном времени?


